{% extends "template.html" %}

{% block conteudo %}
<div class="container">
    <div class="container-fluid">
        <h1>Listar fotos</h1>
    </div>

    <div class="container-fluid">
        <div class="row justify-content-end">
            <div class="col-md-3 d-flex justify-content-end">
                <button type="button" class="btn btn-dark" id="addBtnFoto">Carregar Foto</button>
            </div>
        </div>
        <br>
        <div class="row justify-content-center">
            <div class="col-md-12">
                <table width="100%" id="tabela_fotos" class="table table-striped tabela">
                </table>
            </div>
        </div>
        </div>
</div>

<!-- Modal -->
<div class="modal fade" id="modal01" tabindex="-1" aria-labelledby="modal01" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Carregar Foto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <input type="hidden" class="form-control" id="id_foto" name="id_foto">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="data" class="form-label"><strong>Data:</strong></label>
                            <input type="date" class="form-control form-control-sm" id="data" name="data">
                        </div>
                        <div class="col-md-4">
                            <label for="setor" class="form-label"><strong>Setor:</strong></label>
                            <select class="form-select ml-2" id="setor" name="setor" required>
                                <option value="" disabled selected>Selecione um setor...</option>
                                {% for setor in setoresOpcoes %}
                                    <option value='{{ setor.id }}'>{{ setor.setor }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="subsecao" class="form-label"><strong>Subseção:</strong></label>
                            <select class="form-select ml-2" id="subsecao" name="subsecao" required>
                                <option value="" disabled selected>Selecione uma subseção...</option>
                                {% for subsecao in subsecoesOpcoes %}
                                    <option value='{{ subsecao.id }}'>{{ subsecao.subsecao }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="local" class="form-label"><strong>Local:</strong></label>
                            <select class="form-select ml-2" id="local" name="local" required>
                                <option value="" disabled selected>Selecione um local...</option>
                                {% for local in localOpcoes %}
                                    <option value='{{ local.id }}'>{{ local.local }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="ocorrencia" class="form-label"><strong>Evidência:</strong></label>
                            <select class="form-select ml-2" id="ocorrencia" name="ocorrencia" required>
                                <option value="" disabled selected>Selecione uma evidência...</option>
                                {% for ocorrencia in ocorrenciasOpcoes %}
                                    <option value='{{ ocorrencia.id }}'>{{ ocorrencia.ocorrencia }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="conforme" class="form-label"><strong>Conforme:</strong></label>
                            <select class="form-select ml-2" id="conforme" name="conforme" required>
                                <option value="" disabled selected>Selecione uma opção...</option>
                                <option value="S">Sim</option>
                                <option value="N">Não</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="imbauba" class="form-label"><strong>Lista Imbaúba:</strong></label>
                            <select class="form-select ml-2" id="imbauba" name="imbauba" required>
                                <option value="" disabled selected>Selecione um item...</option>
                                {% for imbauba in imbaubaOpcoes %}
                                    <option value='{{ imbauba.id }}'>{{ imbauba.item }} - {{ imbauba.desc_item }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="castanheira" class="form-label"><strong>Lista Castanheira:</strong></label>
                            <select class="form-select ml-2" id="castanheira" name="castanheira" required>
                                <option value="" disabled selected>Selecione um item...</option>
                                {% for castanheira in castanheiraOpcoes %}
                                    <option value='{{ castanheira.id }}'>{{ castanheira.item }} - {{ castanheira.desc_item }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="paubrasil" class="form-label"><strong>Lista Pau Brasil:</strong></label>
                            <select class="form-select ml-2" id="paubrasil" name="paubrasil" required>
                                <option value="" disabled selected>Selecione um item...</option>
                                {% for pauBrasil in pauBrasilOpcoes %}
                                    <option value='{{ pauBrasil.id }}'>{{ pauBrasil.item }} - {{ pauBrasil.desc_item }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="campo_atuacao" class="form-label"><strong>Campo de Atuação:</strong></label>
                            <select class="form-select ml-2" id="campo_atuacao" name="campo_atuacao" required>
                                <option value="" disabled selected>Selecione um item...</option>
                                {% for campoAtuacao in campoAtuacaoOpcoes %}
                                    <option value='{{ campoAtuacao.id }}'>{{ campoAtuacao.descricao }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="observacao" class="form-label"><strong>Ação Corretiva:</strong></label>
                        <textarea class="form-control" id="observacao" name="observacao" rows="3" max="200"></textarea>
                        <div id="charCount" class="text-end" style="font-size: 12px;">200 caracteres restantes</div>
                    </div>

                </form>
                <div class="mb-3">
                    <label for="imagem" class="form-label"><strong>Escolher arquivo</strong></label>
                    <input class="form-control" type="file" id="imagem" name="imagem">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-dark" id="saveBtn">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="modal02" tabindex="-1" aria-labelledby="modal01" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Detalhes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" class="form-control" id="id_fotoV" name="id_fotoV">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="dataV" class="form-label"><strong>Data:</strong></label>
                        <input type="date" class="form-control form-control-sm" id="dataV" name="dataV" disabled>
                    </div>
                    <div class="col-md-4">
                        <label for="setorV" class="form-label"><strong>Setor:</strong></label>
                        <select class="form-select ml-2" id="setorV" name="setorV" required disabled>
                            <option value="" disabled selected>Selecione um setor...</option>
                            {% for setor in setoresOpcoes %}
                                <option value='{{ setor.id }}'>{{ setor.setor }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="subsecaoV" class="form-label"><strong>Subseção:</strong></label>
                        <select class="form-select ml-2" id="subsecaoV" name="subsecaoV" required disabled>
                            <option value="" disabled selected>Selecione uma subseção...</option>
                            <!-- <?php
                            $con = connect_local_mysqli('gestao_ambiental');
                            $sql = "SELECT * FROM subsecoes ORDER BY 2 ASC";
                            $resultado = mysqli_query($con, $sql);
                            while ($row = mysqli_fetch_assoc($resultado)) {
                                echo "<option value='" . $row['id'] . "'>" . $row['subsecao'] . "</option>";
                            }
                            ?> -->
                        </select>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="localV" class="form-label"><strong>Local:</strong></label>
                        <select class="form-select ml-2" id="localV" name="localV" required disabled>
                            <option value="" disabled selected>Selecione um local...</option>
                            <!-- <?php
                            $con = connect_local_mysqli('gestao_ambiental');
                            $sql = "SELECT * FROM local ORDER BY 2 ASC";
                            $resultado = mysqli_query($con, $sql);
                            while ($row = mysqli_fetch_assoc($resultado)) {
                                echo "<option value='" . $row['id'] . "'>" . $row['local'] . "</option>";
                            }
                            ?> -->
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="ocorrenciaV" class="form-label"><strong>Evidência:</strong></label>
                        <select class="form-select ml-2" id="ocorrenciaV" name="ocorrenciaV" required disabled>
                            <option value="" disabled selected>Selecione uma evidência...</option>
                            <!-- <?php
                            $con = connect_local_mysqli('gestao_ambiental');
                            $sql = "SELECT * FROM ocorrencia";
                            $resultado = mysqli_query($con, $sql);
                            while ($row = mysqli_fetch_assoc($resultado)) {
                                echo "<option value='" . $row['id'] . "'>" . $row['ocorrencia'] . "</option>";
                            }
                            ?> -->
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="conformeV" class="form-label"><strong>Conforme:</strong></label>
                        <select class="form-select ml-2" id="conformeV" name="conformeV" required disabled>
                            <option value="" disabled selected>Selecione uma opção...</option>
                            <option value="S">Sim</option>
                            <option value="N">Não</option>
                        </select>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="imbaubaV" class="form-label"><strong>Lista Imbaúba:</strong></label>
                        <select class="form-select ml-2" id="imbaubaV" name="imbaubaV" required disabled>
                            <option value="" disabled selected>Selecione um item...</option>
                            <!-- <?php
                            $con = connect_local_mysqli('gestao_ambiental');
                            $sql = "SELECT * FROM lista_imbauba ORDER BY 2 ASC";
                            $resultado = mysqli_query($con, $sql);
                            while ($row = mysqli_fetch_assoc($resultado)) {
                                echo "<option value='" . $row['id'] . "'>" . $row['item'] . " - " . $row['desc_item'] . "</option>";
                            }
                            ?> -->
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="castanheiraV" class="form-label"><strong>Lista Castanheira:</strong></label>
                        <select class="form-select ml-2" id="castanheiraV" name="castanheiraV" required disabled>
                            <option value="" disabled selected>Selecione um item...</option>
                            <!-- <?php
                            $con = connect_local_mysqli('gestao_ambiental');
                            $sql = "SELECT * FROM lista_castanheira ORDER BY 2 ASC";
                            $resultado = mysqli_query($con, $sql);
                            while ($row = mysqli_fetch_assoc($resultado)) {
                                echo "<option value='" . $row['id'] . "'>" . $row['item'] . " - " . $row['desc_item'] . "</option>";
                            }
                            ?> -->
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="paubrasilV" class="form-label"><strong>Lista Pau Brasil:</strong></label>
                        <select class="form-select ml-2" id="paubrasilV" name="paubrasilV" required disabled>
                            <option value="" disabled selected>Selecione um item...</option>
                            <!-- <?php
                            $con = connect_local_mysqli('gestao_ambiental');
                            $sql = "SELECT * FROM lista_pau_brasil ORDER BY 2 ASC";
                            $resultado = mysqli_query($con, $sql);
                            while ($row = mysqli_fetch_assoc($resultado)) {
                                echo "<option value='" . $row['id'] . "'>" . $row['item'] . " - " . $row['desc_item'] . "</option>";
                            }
                            ?> -->
                        </select>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-12">
                        <label for="campo_atuacaoV" class="form-label"><strong>Campo de Atuação:</strong></label>
                        <select class="form-select ml-2" id="campo_atuacaoV" name="campo_atuacaoV" required disabled>
                            <option value="" disabled selected>Selecione um item...</option>
                            <!-- <?php
                            $con = connect_local_mysqli('gestao_ambiental');
                            $sql = "SELECT * FROM campo_atuacao ORDER BY 2 ASC";
                            $resultado = mysqli_query($con, $sql);
                            while ($row = mysqli_fetch_assoc($resultado)) {
                                echo "<option value='" . $row['id'] . "'>" . $row['descricao'] . "</option>";
                            }
                            ?> -->
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="observacaoV" class="form-label"><strong>Ação Corretiva:</strong></label>
                    <textarea class="form-control" id="observacaoV" name="observacaoV" rows="3" max="200" disabled></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="fotoModal" tabindex="-1" aria-labelledby="fotoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fotoModalLabel">Visualização da Foto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body text-center">
                <img id="fotoModalImg" src="" alt="Foto" class="img-fluid">
            </div>
        </div>
    </div>
</div>
{% endblock %}
    
{% block javascript %}
<script>
const data = JSON.parse(`{{ fotos|json_encode|raw }}` || '[]');

const getColumnDefs = () => [
    { targets: '_all', className: 'text-center' },
    {
        targets: 0,
        render: (data, type, row) => {
            const iconMap = {
                'S': 'ok.png',
                'N': 'erro.png',
                'P': 'parcial.png',
            };
            return iconMap[row.conforme]
                ? `<img src="/assets/img/alerta/${iconMap[row.conforme]}" style="width: 25px;" />`
                : '';
        },
    },
    {
        targets: -1,
        render: (data, type, row) => `
            <div class="d-flex justify-content-center align-items-center">
                <button class="btn btn-sm btn-outline-dark edit me-1" data-id="${row.id_fotos}">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger delete" data-id="${row.id_fotos}">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `,
        orderable: false,
        searchable: false,
        width: "100px",
    },
];

const getTableColumns = () => [
    {
        data: null,
        defaultContent: '-',
    },
    { data: 'id_fotos', title: 'ID' },
    { data: 'nome_arquivo', title: 'Arquivo' },
    { data: 'data', title: 'Data', render: data => data ? data.split('-').reverse().join('/') : '' },
    // { data: 'id_setor', title: 'Setor', defaultContent: '-' },
    // { data: 'id_subsecao', title: 'Subseção', defaultContent: '-' },
    // { data: 'id_local', title: 'Local', defaultContent: '-' },
    // { data: 'id_ocorrencia', title: 'Ocorrência', defaultContent: '-' },
    { data: 'setor', title: 'Setor', defaultContent: '-' },
    { data: 'subsecao', title: 'Subseção', defaultContent: '-' },
    { data: 'local', title: 'Local', defaultContent: '-' },
    { data: 'ocorrencia', title: 'Ocorrência', defaultContent: '-' },
    { data: 'observacao', title: 'Observação', defaultContent: '-' },
    { data: null, title: 'Ações', defaultContent: '' },
];

carregarDatatable('#tabela_fotos', data);

// Eventos
$('#tabela_fotos').on('click', '.edit', async function () {
    const id = $(this).data('id');
    try {
        const response = await fetchJSON(`{{ url_for('editarFoto') }}`, 'POST', { id });
        const details = response?.dados?.[0];
        if (details) {
            Object.keys(details).forEach(key => {
                const input = document.getElementById(`${key}V`);
                if (input) input.value = details[key];
            });
            $('#modal02').modal('show');
        } else {
            alert('Erro: Nenhum dado encontrado.');
        }
    } catch (error) {
        console.error('Erro ao carregar dados:', error);
    }
});

$('#tabela_fotos').on('click', '.delete', async function () {
    const id = $(this).data('id');
    if (confirm('Você tem certeza que deseja deletar este registro?')) {
        try {
            const response = await fetchJSON(`{{ url_for('deletarFoto') }}`, 'POST', { id });
            if (response?.dados) {
                alert('Registro deletado com sucesso!');
                window.location.reload();
            } else {
                alert(`Erro ao deletar registro: ${response?.error || 'Erro desconhecido'}`);
            }
        } catch (error) {
            console.error('Erro ao deletar registro:', error);
        }
    }
});

        const handleSave = async () => {
            const formData = new FormData();

            // Campos que precisam ser enviados
            const fields = ['conforme', 'setor', 'data', 'subsecao', 'local', 'ocorrencia',
                            'observacao', 'castanheira', 'imbauba', 'paubrasil', 'campo_atuacao'];

            // Adiciona campos normais ao FormData
            fields.forEach(field => {
                const element = getElement(field);
                if (element) {
                    formData.append(field, element.value || '');
                }
            });

            // Trata o campo de arquivo separadamente
            const fileInput = getElement('imagem');
            if (fileInput && fileInput.files.length > 0) {
                formData.append('imagem', fileInput.files[0]);
            } else {
                alert('Por favor, selecione um arquivo.');
                return; // Para evitar enviar a requisição sem o arquivo
            }

            try {
                // Envia a requisição para o servidor
                const response = await fetch(`{{ url_for('salvarFoto') }}`, {
                    method: 'POST',
                    body: formData,
                });

                // Processa a resposta do servidor
                const result = await response.json();
                
                alert('Dados salvos com sucesso!');
                window.location.reload();
            } catch (error) {
                console.error('Erro ao salvar dados:', error);
                alert('Erro ao salvar os dados.');
            }
        };

        enforceMaxLength(getElement('observacao'), maxChars);
        getElement('saveBtn').addEventListener('click', handleSave);
        getElement('addBtnFoto').addEventListener('click', () => $('#modal01').modal('show'));
        
</script>
{% endblock %}